<!--templates/visitas/historial.html-->
{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
<h2 class="text-center mb-4">游늵 Historial de Visitas de {{ request.user.get_full_name }}</h2>
  <!-- KPIs -->
  <div class="row mb-4 text-center">
    <div class="col-md-3">
      <div class="card bg-primary text-white p-3 shadow">
        <h6>Visitas esta semana</h6>
        <h3>{{ total_visitas_semana }}</h3>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white p-3 shadow">
        <h6>Productos presentados</h6>
        <h3>{{ total_productos_presentados }}</h3>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-white p-3 shadow">
        <h6>Entregas realizadas</h6>
        <h3>{{ total_entregas }}</h3>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white p-3 shadow">
        <h6>Tiempo promedio por visita</h6>
        <h3>{{ tiempo_promedio }} min</h3>
      </div>
    </div>
  </div>

  <!-- Gr치ficos -->
  <div class="row mb-4">
    <div class="col-md-4">
      <canvas id="visitasSemana"></canvas>
    </div>
    <div class="col-md-4">
      <canvas id="productosTipo"></canvas>
    </div>
    <div class="col-md-4">
      <canvas id="topDoctores"></canvas>
    </div>
  </div>

  <!-- Pesta침as -->
  <ul class="nav nav-tabs">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#visitas">Visitas Realizadas</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#presentados">Productos Presentados</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#entregas">Entregas Realizadas</a></li>
  </ul>

  <div class="tab-content mt-3">
    <!-- Visitas -->
    <div class="tab-pane fade show active" id="visitas">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Doctor</th>
            <th>Fecha Inicio</th>
            <th>Fecha Final</th>
            <th>Duraci칩n (min)</th>
            <th>Comentarios</th>
          </tr>
        </thead>
        <tbody>
          {% for v in visitas %}
          <tr>
            <td>{{ v.doctor.nombre }}</td>
            <td>{{ v.fecha_inicio|date:"d/m/Y H:i" }}</td>
            <td>{% if v.fecha_final %}{{ v.fecha_final|date:"d/m/Y H:i" }}{% else %}-{% endif %}</td>
<td>
  {% if v.duracion %}
    {{ v.duracion }}
  {% else %}
    -
  {% endif %}
</td>

            <td>{{ v.comentarios|default:"-" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Productos Presentados -->
    <div class="tab-pane fade" id="presentados">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Doctor</th>
            <th>Producto</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody>
          {% for p in presentados %}
          <tr>
            <td>{{ p.visita.doctor.nombre }}</td>
            <td>{{ p.producto.nombre }}</td>
            <td>{{ p.visita.fecha_inicio|date:"d/m/Y" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Entregas Realizadas -->
    <div class="tab-pane fade" id="entregas">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Doctor</th>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Tipo entrega</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody>
          {% for e in detalles %}
          <tr>
            <td>{{ e.visita.doctor.nombre }}</td>
            <td>{{ e.producto.nombre }}</td>
            <td>{{ e.cantidad }}</td>
            <td>{{ e.tipo_entrega }}</td>
            <td>{{ e.visita.fecha_inicio|date:"d/m/Y" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Datos como JSON -->
<script type="application/json" id="visitasLabels">{{ visitas_semana_labels|safe }}</script>
<script type="application/json" id="visitasData">{{ visitas_semana_data|safe }}</script>
<script type="application/json" id="productosLabels">{{ productos_tipo_labels|safe }}</script>
<script type="application/json" id="productosData">{{ productos_tipo_data|safe }}</script>
<script type="application/json" id="doctoresLabels">{{ top_doctores_labels|safe }}</script>
<script type="application/json" id="doctoresData">{{ top_doctores_data|safe }}</script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Leer datos desde el HTML
const visitasLabels = JSON.parse(document.getElementById('visitasLabels').textContent);
const visitasData = JSON.parse(document.getElementById('visitasData').textContent);
const productosLabels = JSON.parse(document.getElementById('productosLabels').textContent);
const productosData = JSON.parse(document.getElementById('productosData').textContent);
const doctoresLabels = JSON.parse(document.getElementById('doctoresLabels').textContent);
const doctoresData = JSON.parse(document.getElementById('doctoresData').textContent);

// Gr치fico Visitas por semana
new Chart(document.getElementById('visitasSemana'), {
    type: 'bar',
    data: {
        labels: visitasLabels,
        datasets: [{
            label: 'Visitas',
            data: visitasData,
            backgroundColor: 'rgba(54, 162, 235, 0.6)'
        }]
    }
});

// Gr치fico Productos por tipo
new Chart(document.getElementById('productosTipo'), {
    type: 'pie',
    data: {
        labels: productosLabels,
        datasets: [{
            label: 'Cantidad',
            data: productosData,
            backgroundColor: ['#36A2EB','#FF6384','#FFCE56']
        }]
    }
});

// Gr치fico Top doctores
new Chart(document.getElementById('topDoctores'), {
    type: 'bar',
    data: {
        labels: doctoresLabels,
        datasets: [{
            label: 'Visitas',
            data: doctoresData,
            backgroundColor: 'rgba(153, 102, 255, 0.6)'
        }]
    }
});
</script>
{% endblock %}