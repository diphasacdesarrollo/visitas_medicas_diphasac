<!--templates/visitas/historial.html-->
{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">

  <h2 class="text-center mb-3">üìä Historial de Visitas de {{ request.user.get_full_name }}</h2>

  <!-- Navegaci√≥n por semanas -->
  <form method="get" class="row g-2 align-items-end mb-3">
    <input type="hidden" name="month" value="{{ month_value }}">
    <div class="col-auto">
      <label class="form-label mb-0">Ir a semana</label>
      <input type="week" class="form-control" name="weekpick" value="{{ weekpick_value }}">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary">Aplicar</button>
    </div>

    <div class="col-auto ms-auto">
      <div class="btn-group">
        <a class="btn btn-outline-primary"
           href="?semana={{ semana_anterior }}&a√±o={{ a√±o_anterior }}&month={{ month_value }}">
          ‚¨Ö Semana anterior
        </a>
        <span class="btn btn-light disabled">
          Semana {{ semana_actual }} ‚Äì {{ a√±o_actual }}
        </span>
        <a class="btn btn-outline-primary"
           href="?semana={{ semana_siguiente }}&a√±o={{ a√±o_siguiente }}&month={{ month_value }}">
          Semana siguiente ‚û°
        </a>
      </div>
    </div>
  </form>

  <!-- Selector de mes (Cobertura) -->
  <form method="get" class="row g-2 align-items-end mb-4">
    <input type="hidden" name="semana" value="{{ semana_actual }}">
    <input type="hidden" name="a√±o" value="{{ a√±o_actual }}">
    <div class="col-auto">
      <label class="form-label mb-0">Cobertura del mes</label>
      <input type="month" class="form-control" name="month" value="{{ month_value }}">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary">Aplicar</button>
    </div>
  </form>

  <!-- KPI Mensuales (Cobertura) -->
  <div class="row mb-4 text-center">
    <div class="col-md-3">
      <div class="card bg-dark text-white p-3 shadow">
        <h6>Cobertura (este mes)</h6>
        <h3>{{ cobertura_pct }}%</h3>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white p-3 shadow">
        <h6>Visitados</h6>
        <h3>{{ visitados_count }}</h3>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-white p-3 shadow">
        <h6>Pendientes</h6>
        <h3>{{ pendientes }}</h3>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white p-3 shadow">
        <h6>Asignados totales</h6>
        <h3>{{ asignados_total }}</h3>
      </div>
    </div>
  </div>

  <!-- Aviso si no hay datos en la semana -->
  {% if total_visitas_semana == 0 and total_entregas == 0 and total_productos_presentados == 0 %}
    <div class="alert alert-info">
      No hay registros para la semana {{ semana_actual }}‚Äì{{ a√±o_actual }}.
      Usa el selector o los botones para cambiar de semana.
    </div>
  {% endif %}

  <!-- Gr√°ficos -->
  <div class="row mb-4">
    <div class="col-md-4">
      <canvas id="visitasSemana"></canvas>
    </div>
    <div class="col-md-4">
      <canvas id="coberturaMes"></canvas>
      <p class="text-center mt-2">
        Cobertura: <strong>{{ cobertura_pct }}%</strong>
        ({{ visitados_count }} de {{ asignados_total }} m√©dicos asignados)
      </p>
    </div>
    <div class="col-md-4">
      <canvas id="topDoctores"></canvas>
    </div>
  </div>

  <!-- Pesta√±as -->
  <ul class="nav nav-tabs">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#visitas">Visitas Realizadas</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#presentados">Productos Presentados</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#entregas">Entregas Realizadas</a></li>
  </ul>

  <div class="tab-content mt-3">
    <!-- Visitas -->
    <div class="tab-pane fade show active" id="visitas">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Medico üë®‚Äç‚öïÔ∏è</th>
            <th>CMP</th>
            <th>Especialidad</th>
            <th>Fecha</th>
            <th>Comentario</th>
          </tr>
        </thead>
        <tbody>
          {% for v in visitas %}
          <tr>
            <td>{{ v.doctor.apellido|default:'' }} - {{ v.doctor.nombre|default:'' }}</td>
            <td>{{ v.doctor.cmp|default:"-" }}</td>
            <td>
              {# Si especialidad es FK, intenta .nombre; si es CharField, muestra directo #}
              {% if v.doctor.especialidad %}
                {{ v.doctor.especialidad.nombre|default:v.doctor.especialidad }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>{{ v.fecha_inicio|date:"d/m/Y H:i" }}</td>
            <td>{{ v.comentarios|default:"-" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Productos Presentados -->
    <div class="tab-pane fade" id="presentados">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Doctor</th>
            <th>Producto</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody>
          {% for p in presentados %}
          <tr>
            <td>{{ p.visita.doctor.apellido|default:'' }} - {{ p.visita.doctor.nombre|default:'' }}</td>
            <td>{{ p.producto.nombre }}</td>
            <td>{{ p.visita.fecha_inicio|date:"d/m/Y" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Entregas Realizadas -->
    <div class="tab-pane fade" id="entregas">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Doctor</th>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Tipo entrega</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody>
          {% for e in detalles %}
          <tr>
            <td>{{ e.visita.doctor.apellido|default:'' }} - {{ e.visita.doctor.nombre|default:'' }}</td>
            <td>{{ e.producto.nombre }}</td>
            <td>{{ e.cantidad }}</td>
            <td>{{ e.tipo_entrega }}</td>
            <td>{{ e.visita.fecha_inicio|date:"d/m/Y" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Datos como JSON -->
<script type="application/json" id="visitasLabels">{{ visitas_semana_labels|safe }}</script>
<script type="application/json" id="visitasData">{{ visitas_semana_data|safe }}</script>
<script type="application/json" id="coberturaLabels">{{ cobertura_labels|safe }}</script>
<script type="application/json" id="coberturaData">{{ cobertura_data|safe }}</script>
<script type="application/json" id="doctoresLabels">{{ top_doctores_labels|safe }}</script>
<script type="application/json" id="doctoresData">{{ top_doctores_data|safe }}</script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Leer datos desde el HTML
const visitasLabels   = JSON.parse(document.getElementById('visitasLabels').textContent);
const visitasData     = JSON.parse(document.getElementById('visitasData').textContent);
const coberturaLabels = JSON.parse(document.getElementById('coberturaLabels').textContent);
const coberturaData   = JSON.parse(document.getElementById('coberturaData').textContent);
const doctoresLabels  = JSON.parse(document.getElementById('doctoresLabels').textContent);
const doctoresData    = JSON.parse(document.getElementById('doctoresData').textContent);

// Gr√°fico Visitas por semana (barras)
new Chart(document.getElementById('visitasSemana'), {
  type: 'bar',
  data: {
    labels: visitasLabels,
    datasets: [{
      label: 'Visitas',
      data: visitasData,
      backgroundColor: 'rgba(54, 162, 235, 0.6)'
    }]
  }
});

// Gr√°fico Cobertura mensual (donut)
new Chart(document.getElementById('coberturaMes'), {
  type: 'doughnut',
  data: {
    labels: coberturaLabels,          // ["Visitados", "Pendientes"]
    datasets: [{
      label: 'Cobertura',
      data: coberturaData,            // [visitados, pendientes]
      backgroundColor: ['#36A2EB','#FF6384']
    }]
  }
});

// Gr√°fico Top doctores (barras)
new Chart(document.getElementById('topDoctores'), {
  type: 'bar',
  data: {
    labels: doctoresLabels,
    datasets: [{
      label: 'Visitas',
      data: doctoresData,
      backgroundColor: 'rgba(153, 102, 255, 0.6)'
    }]
  }
});
</script>
{% endblock %}